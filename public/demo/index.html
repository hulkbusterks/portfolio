<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go (Wasm) vs Python (Pyodide): The Performance Wars</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Courier New', Courier, monospace; }
        #stats {
            position: absolute; top: 10px; left: 10px; color: white; z-index: 100;
            background: rgba(0, 0, 0, 0.7); padding: 10px; border: 1px solid #444; pointer-events: none;
        }
        .stat-line { margin: 5px 0; font-size: 14px; }
        b.go { color: #00ADD8; }
        b.py { color: #FFE873; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="stats">
        <div class="stat-line"><b class="go">GO (Wasm)</b></div>
        <div class="stat-line">Units: <span id="go-count">0</span></div>
        <div class="stat-line">Avg Time: <span id="go-time">0</span> ms</div>
        <div class="stat-line">RAM: <span id="go-ram">—</span> MB</div>
        <hr style="border-color: #555">
        <div class="stat-line"><b class="py">PYTHON (Pyodide)</b></div>
        <div class="stat-line">Units: <span id="py-count">0</span></div>
        <div class="stat-line">Avg Time: <span id="py-time">0</span> ms</div>
        <div class="stat-line">RAM: <span id="py-ram">—</span> MB</div>
    </div>

    <div id="loading">Initialising Wasm Engines...<br><span style="font-size:16px; color:#aaa">Downloading Pyodide & Go Wasm...</span></div>

    <!-- Game Container -->
    <div id="game-container" style="width: 100%; height: 100vh;"></div>

    <script>
        // --- PHASER CONFIG ---
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            transparent: true,
            physics: {
                default: 'arcade',
                arcade: { gravity: { y: 0 }, debug: false }
            },
            scene: { preload: preload, create: create, update: update, resize: resize }
        };

        const game = new Phaser.Game(config);
        
        // --- GAME STATE ---
        let goGroup, pyGroup;
        let stats = {
            go: { count: 0, totalTime: 0, samples: 0, lastRAM: null, maxRAM: null },
            python: { count: 0, totalTime: 0, samples: 0, lastRAM: null, maxRAM: null }
        };
        let goWorkerRef = null, pyWorkerRef = null;
        let gameOver = false;

        function preload() { }

        function create() {
            goGroup = this.physics.add.group();
            pyGroup = this.physics.add.group();

            this.physics.add.collider(goGroup, pyGroup, (goUnit, pyUnit) => {
                goUnit.destroy();
                pyUnit.destroy();
            });

            // --- WORKER SETUP ---
            startWorkers(this);
        }

        function startWorkers(scene) {
            // Cache-bust the workers to avoid stale code in the browser
            goWorkerRef = new Worker('worker-go.js?cb=' + Date.now());
            goWorkerRef.onmessage = (e) => {
                const data = JSON.parse(e.data);
                hideLoading();
                if (!gameOver) {
                    updateStats('go', data);
                    spawnUnit(scene, 'go');
                }
            };
            
            // 2. Python Worker
            pyWorkerRef = new Worker('worker-py.js?cb=' + Date.now());
            pyWorkerRef.onmessage = (e) => {
                const data = JSON.parse(e.data);
                hideLoading();
                if (!gameOver) {
                    updateStats('python', data);
                    spawnUnit(scene, 'python');
                }
            };
        }

        let loadingHidden = false;
        function hideLoading() {
            if (!loadingHidden) {
                document.getElementById('loading').style.display = 'none';
                loadingHidden = true;
            }
        }

        function update() {
            // BATTLE LOGIC (Same as before)
            // Go AI
            goGroup.children.iterate((goUnit) => {
                if (!goUnit || !goUnit.active) return;
                let nearestEnemy = null, minDist = Infinity;
                pyGroup.children.iterate((pyUnit) => {
                    if (!pyUnit || !pyUnit.active) return;
                    const dist = Phaser.Math.Distance.Between(goUnit.x, goUnit.y, pyUnit.x, pyUnit.y);
                    if (dist < minDist) { minDist = dist; nearestEnemy = pyUnit; }
                });

                if (nearestEnemy) {
                    this.physics.moveToObject(goUnit, nearestEnemy, 150 + Math.random() * 50);
                } else {
                    const distToCenter = Phaser.Math.Distance.Between(goUnit.x, goUnit.y, window.innerWidth/2, window.innerHeight/2);
                    if (distToCenter > 100) this.physics.moveTo(goUnit, window.innerWidth/2, window.innerHeight/2, 100);
                    else goUnit.body.setVelocity(Math.random()*40-20, Math.random()*40-20);
                }
            });

            // Python AI
            pyGroup.children.iterate((pyUnit) => {
                if (!pyUnit || !pyUnit.active) return;
                let nearestEnemy = null, minDist = Infinity;
                goGroup.children.iterate((goUnit) => {
                    if (!goUnit || !goUnit.active) return;
                    const dist = Phaser.Math.Distance.Between(pyUnit.x, pyUnit.y, goUnit.x, goUnit.y);
                    if (dist < minDist) { minDist = dist; nearestEnemy = goUnit; }
                });

                if (nearestEnemy) {
                    this.physics.moveToObject(pyUnit, nearestEnemy, 100 + Math.random() * 30);
                } else {
                    this.physics.moveTo(pyUnit, window.innerWidth/2, window.innerHeight/2, 80);
                }
            });
            
            // Win logic: stop when one side has no active units after some spawns
            if (!gameOver) {
                const goAlive = goGroup.countActive(true);
                const pyAlive = pyGroup.countActive(true);
                const enoughSpawns = stats.go.count + stats.python.count > 50; // avoid instant stop on init
                if (enoughSpawns && (goAlive === 0 || pyAlive === 0)) {
                    gameOver = true;
                    stopWorkers();
                    this.physics.pause();
                    const winner = goAlive === 0 ? 'Python (Pyodide)' : 'Go (Wasm)';
                    showResults(winner);
                }
            }
        }

        function stopWorkers() {
            if (goWorkerRef) { goWorkerRef.terminate(); goWorkerRef = null; }
            if (pyWorkerRef) { pyWorkerRef.terminate(); pyWorkerRef = null; }
        }

        function showResults(winner) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:24px 28px;border:1px solid #555;z-index:1500;min-width:320px;text-align:center;font-family:Courier New, monospace;box-shadow:0 10px 30px rgba(0,0,0,0.6)';

            const goAvg = stats.go.samples ? (stats.go.totalTime / stats.go.samples / 1e6).toFixed(2) : '0.00';
            const pyAvg = stats.python.samples ? (stats.python.totalTime / stats.python.samples / 1e6).toFixed(2) : '0.00';
            const formatMB = (v) => {
                if (v === null || Number.isNaN(v)) return '—';
                if (v < 0.01) return '<0.01 MB';
                return v.toFixed(2) + ' MB';
            };

            const goRAM = formatMB(stats.go.lastRAM);
            const pyRAM = formatMB(stats.python.lastRAM);
            const goRAMPeak = formatMB(stats.go.maxRAM);
            const pyRAMPeak = formatMB(stats.python.maxRAM);
            const speedRatio = (stats.go.samples && stats.python.samples)
                ? ((stats.python.totalTime / stats.python.samples) / (stats.go.totalTime / stats.go.samples)).toFixed(2)
                : '—';

            overlay.innerHTML = `
                <div style="font-size:22px;margin-bottom:8px;color:${winner.includes('Go') ? '#00ADD8' : '#FFE873'}">${winner} wins</div>
                <div style="font-size:14px;margin-bottom:16px;color:#aaa">Battle complete</div>
                <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px;">
                    <tr style="color:#ccc"><th style="text-align:left;padding:4px 6px;border-bottom:1px solid #444">Metric</th><th style="text-align:right;padding:4px 6px;border-bottom:1px solid #444">Go</th><th style="text-align:right;padding:4px 6px;border-bottom:1px solid #444">Python</th></tr>
                    <tr><td style="padding:4px 6px;border-bottom:1px solid #333">Total Units</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${stats.go.count}</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${stats.python.count}</td></tr>
                    <tr><td style="padding:4px 6px;border-bottom:1px solid #333">Avg Time / op (ms)</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${goAvg}</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${pyAvg}</td></tr>
                    <tr><td style="padding:4px 6px;border-bottom:1px solid #333">Memory (MB, latest)</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${goRAM}</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${pyRAM}</td></tr>
                    <tr><td style="padding:4px 6px;border-bottom:1px solid #333">Memory (MB, peak)</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${goRAMPeak}</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${pyRAMPeak}</td></tr>
                    <tr><td style="padding:4px 6px;border-bottom:1px solid #333">Speed multiplier</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">1x</td><td style="text-align:right;padding:4px 6px;border-bottom:1px solid #333">${speedRatio === '—' ? '—' : speedRatio + 'x slower'}</td></tr>
                </table>
                <button id="restart-btn" style="padding:10px 16px;border:1px solid #666;background:#111;color:white;cursor:pointer;font-family:inherit;">Restart War</button>
            `;

            document.body.appendChild(overlay);
            const btn = overlay.querySelector('#restart-btn');
            if (btn) btn.onclick = () => { location.reload(); };
        }

        function spawnUnit(scene, lang) {
            let x, y, color, group;
            if (lang === 'go') {
                x = Phaser.Math.Between(10, 50);
                y = Phaser.Math.Between(50, window.innerHeight - 50);
                color = 0x00ADD8;
                group = goGroup;
            } else {
                x = Phaser.Math.Between(window.innerWidth - 50, window.innerWidth - 10);
                y = Phaser.Math.Between(50, window.innerHeight - 50);
                color = 0xFFE873;
                group = pyGroup;
            }
            if(!scene || !scene.add) return;
            const unit = scene.add.rectangle(x, y, 10, 10, color);
            scene.physics.add.existing(unit);
            unit.body.setCollideWorldBounds(true);
            unit.body.setBounce(0.5);
            group.add(unit);
        }

        function updateStats(lang, data) {
            stats[lang].count++;
            stats[lang].samples++;
            stats[lang].totalTime += data.durationNs;
            if (typeof data.memoryMB === 'number') {
                stats[lang].lastRAM = data.memoryMB;
                if (stats[lang].maxRAM === null || data.memoryMB > stats[lang].maxRAM) {
                    stats[lang].maxRAM = data.memoryMB;
                }
            }

            if (lang === 'go') {
                document.getElementById('go-count').innerText = stats.go.count;
                document.getElementById('go-time').innerText = (stats.go.totalTime / stats.go.samples / 1e6).toFixed(2);
                document.getElementById('go-ram').innerText = (stats.go.lastRAM !== null ? (stats.go.lastRAM < 0.01 ? '<0.01' : stats.go.lastRAM.toFixed(2)) : '—');
            } else {
                document.getElementById('py-count').innerText = stats.python.count;
                document.getElementById('py-time').innerText = (stats.python.totalTime / stats.python.samples / 1e6).toFixed(2);
                document.getElementById('py-ram').innerText = (stats.python.lastRAM !== null ? (stats.python.lastRAM < 0.01 ? '<0.01' : stats.python.lastRAM.toFixed(2)) : '—');
            }
        }
        
        // Resize Handler
        window.addEventListener('resize', () => { game.scale.resize(window.innerWidth, window.innerHeight); });
        function resize (width, height) { 
            if (width === undefined) { width = this.sys.game.config.width; }
            if (height === undefined) { height = this.sys.game.config.height; }
            this.cameras.resize(width, height); 
        }

    </script>
</body>
</html>
